name: Monorepo CI/CD (Self-hosted Windows)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Ensure Minikube is running (do NOT restart if already up)
    - name: Ensure Minikube is running
      shell: powershell
      run: |
        minikube status || minikube start --driver=docker

    # IMPORTANT: Docker env + build must be in SAME step
    - name: Build Docker images inside Minikube
      shell: powershell
      run: |
        minikube docker-env --shell powershell | Invoke-Expression

        docker build -t frontend-app1 apps/frontend-app-1
        docker build -t frontend-app2 apps/frontend-app-2
        docker build -t frontend-app3 apps/frontend-app-3

        docker build -t backend-api1 apps/backend-api-1
        docker build -t backend-api2 apps/backend-api-2

    - name: Deploy Kubernetes manifests
      shell: powershell
      run: |
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/backend-api-1
        kubectl apply -f k8s/backend-api-2
        kubectl apply -f k8s/frontend-app-1
        kubectl apply -f k8s/frontend-app-2
        kubectl apply -f k8s/frontend-app-3

    - name: Restart deployments to pick up new images
      shell: powershell
      run: |
        kubectl rollout restart deployment backend-api1 -n monorepo-app
        kubectl rollout restart deployment backend-api2 -n monorepo-app

        kubectl rollout restart deployment frontend-app1 -n monorepo-app
        kubectl rollout restart deployment frontend-app2 -n monorepo-app
        kubectl rollout restart deployment frontend-app3 -n monorepo-app

    - name: Verify Deployment
      shell: powershell
      run: |
        kubectl get pods -n monorepo-app
        kubectl get svc -n monorepo-app
